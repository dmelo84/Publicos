 SELECT ZCA_CODIGO,
        ZCA.R_E_C_N_O_ AS ZCA_RECNO, 
 		SE1.R_E_C_N_O_ AS SE1_RECNO, 
 		ZCA.ZCA_SALDO, 
 		ZCA.ZCA_DTPAG, 
 		SE1.E1_SALDO, 
 		SE1.E1_FILIAL 
 FROM ZCA010 ZCA WITH(NOLOCK) 
 INNER JOIN SE1010 SE1  WITH(NOLOCK) 
 	ON  SE1.E1_EMISSAO >= ZCA_DTVEND 
 	AND SE1.E1_XBAND = ZCA_CODBAN 
 	AND SE1.E1_XCODAUT = ZCA_CODAUT 
 	AND SE1.E1_XPARCAR = CASE WHEN ZCA_NUMPAC > 0 AND ZCA_QTDPAR > 1 THEN  RIGHT('000'+CONVERT(VARCHAR, ZCA_NUMPAC) ,3) ELSE '' END 
 	AND SE1.D_E_L_E_T_  =  ''  
 WHERE ZCA_FILIAL = '' 
 AND ZCA_CODBAN = '004' 
 AND ZCA_CODADQ = '002' 
 AND ZCA_DTVEND BETWEEN '20210101' AND '20211231' 
 AND ZCA_DTPAG BETWEEN '20211007' AND '20211007' 
 AND ZCA_SALDO > 0 
  AND ZCA_STATUS NOT IN  ('3','6') 
 AND NOT (ZCA_DTPROC = '20211008' AND ZCA_HRPROC = '15:54:48')  AND ZCA.ZCA_TPMOV = '1' 
 AND ZCA.D_E_L_E_T_ = '' 
                  '000002139838'
 AND ZCA_CODIGO = '000002139838'
  AND NOT EXISTS (SELECT 1 AS 'A' 
  				FROM ZCB010 ZCB 
 				WHERE ZCB_FILIAL= '' 
 				AND ZCB_CODMOV = ZCA_CODIGO 
 				and ZCB_TPOPER = '3' 
 				AND ZCB.D_E_L_E_T_ = '' ) 
 ORDER BY ZCA_STATUS, ZCA_CODIGO 





SELECT 	SC5.C5_FILIAL, COUNT(*) AS QTDPED 
FROM  SC5010 SC5  with(nolock)
INNER JOIN  SA1010 SA1  with(nolock) ON SC5.C5_CLIENTE = SA1.A1_COD AND SC5.C5_LOJACLI = SA1.A1_LOJA AND SA1.D_E_L_E_T_ = ''  
AND SA1.A1_PESSOA = 'F'  
WHERE SC5.D_E_L_E_T_ <> '*' AND SC5.C5_XIDPLE <> ''  
AND NOT EXISTS ( SELECT 	C9_PEDIDO FROM SC9010 SC9 WHERE  
                       	SC5.C5_FILIAL = SC9.C9_FILIAL AND  
                         	SC5.C5_NUM = SC9.C9_PEDIDO AND  
                         	SC9.C9_NFISCAL <> '' AND SC9.D_E_L_E_T_ <> '*' )  
AND SC5.C5_BLQ = ' '  
AND SC5.C5_XBLQ IN ('4','7') AND SC5.C5_EMISSAO >= '20170201'  
GROUP BY SC5.C5_FILIAL 
ORDER BY 2 DESC 




SELECT 	 COUNT(*) AS QTDPED 
FROM  SC5010 SC5  with(nolock)
INNER JOIN  SA1010 SA1  with(nolock) ON SC5.C5_CLIENTE = SA1.A1_COD AND SC5.C5_LOJACLI = SA1.A1_LOJA AND SA1.D_E_L_E_T_ = ''  
AND SA1.A1_PESSOA = 'F'  
WHERE SC5.D_E_L_E_T_ <> '*' AND SC5.C5_XIDPLE <> ''  
AND NOT EXISTS ( SELECT 	C9_PEDIDO FROM SC9010 SC9 WHERE  
                       	SC5.C5_FILIAL = SC9.C9_FILIAL AND  
                         	SC5.C5_NUM = SC9.C9_PEDIDO AND  
                         	SC9.C9_NFISCAL <> '' AND SC9.D_E_L_E_T_ <> '*' )  
AND SC5.C5_BLQ = ' '  
AND SC5.C5_XBLQ IN ('4','7') AND SC5.C5_EMISSAO >= '20170201'  



SELECT COUNT(*) AS QTDE
FROM (
SELECT E2_FILIAL,E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_FORNECE,E2_LOJA, MAX(R_E_C_N_O_) as SE2_RECNO
FROM SE2010 SE2
WHERE SE2.D_E_L_E_T_ = ''
GROUP BY E2_FILIAL,E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_FORNECE,E2_LOJA
HAVING COUNT(*) > 1
) A



SELECT MAX(E2_EMISSAO) E2_EMISSAO
FROM SE2010 SE2
INNER JOIN  (
				SELECT E2_FILIAL,E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_FORNECE,E2_LOJA, count(*) B
				FROM SE2010 SE2
				WHERE SE2.D_E_L_E_T_ = ''
				GROUP BY E2_FILIAL,E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_FORNECE,E2_LOJA
				HAVING COUNT(*) > 1
				) A
ON SE2.E2_FILIAL  = A.E2_FILIAL
AND SE2.E2_PREFIXO = A.E2_PREFIXO
AND SE2.E2_NUM     = A.E2_NUM
AND SE2.E2_PARCELA = A.E2_PARCELA
AND SE2.E2_TIPO    = A.E2_TIPO
AND SE2.E2_FORNECE = A.E2_FORNECE
AND SE2.E2_LOJA    = A.E2_LOJA
WHERE SE2.D_E_L_E_T_ = ''


SELECT count(*)
-- UPDATE D_E_L_E_T_ = '*', R_E_C_D_E_L_ = R_E_C_N_O_ 
FROM SE2010 SE2
INNER JOIN (
			SELECT E2_FILIAL,E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_FORNECE,E2_LOJA, MAX(R_E_C_N_O_) as SE2_RECNO
			FROM SE2010 SE2
			WHERE SE2.D_E_L_E_T_ = ''
			GROUP BY E2_FILIAL,E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_FORNECE,E2_LOJA
			HAVING COUNT(*) > 1) A
		ON SE2.R_E_C_N_O_ = A.SE2_RECNO


UPDATE D_E_L_E_T_ = '*', R_E_C_D_E_L_ = R_E_C_N_O_  FROM SE2010 SE2  INNER JOIN (   			SELECT E2_FILIAL,E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_FORNECE,E2_LOJA, MAX(R_E_C_N_O_) as SE2_RECNO  			FROM SE2010 SE2  			WHERE SE2.D_E_L_E_T_ = ''  			GROUP BY E2_FILIAL,E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_FORNECE,E2_LOJA  			HAVING COUNT(*) > 1) A  		ON SE2.R_E_C_N_O_ = A.SE2_RECNO